<section class="demo-section" id="contact">
    <div class="container">
        <h3>ðŸ“¬ Contact Me</h3>
        <p class="section-description">
            Have questions about my work or want to collaborate? 
            I'd love to hear from you!
        </p>
        
        <div class="category-card contact-card">
            <form id="contactForm" class="contact-form" novalidate>
                <input 
                    type="text" 
                    name="website_hp" 
                    id="website_hp"
                    style="display:none !important; position: absolute; left: -9999px;" 
                    tabindex="-1" 
                    autocomplete="off"
                    aria-hidden="true">
                
                <div class="form-group">
                    <label for="contactName">Name *</label>
                    <input 
                        type="text" 
                        id="contactName" 
                        name="name"
                        placeholder="Your Name" 
                        required
                        minlength="2"
                        maxlength="100"
                        class="form-input">
                    <span class="form-error" id="nameError"></span>
                </div>
                
                <div class="form-group">
                    <label for="contactEmail">Email *</label>
                    <input 
                        type="email" 
                        id="contactEmail" 
                        name="email"
                        placeholder="your.email@example.com" 
                        required
                        maxlength="150"
                        class="form-input">
                    <span class="form-error" id="emailError"></span>
                </div>
                
                <div class="form-group">
                    <label for="contactMessage">Message *</label>
                    <textarea 
                        id="contactMessage" 
                        name="message"
                        placeholder="Type your message here..." 
                        required
                        minlength="10"
                        maxlength="5000"
                        rows="6"
                        class="form-input form-textarea"></textarea>
                    <span class="form-error" id="messageError"></span>
                    <span class="character-count" id="charCount">0 / 5000</span>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">
                    <span class="btn-text">Send Message</span>
                    <span class="btn-icon">ðŸ“§</span>
                </button>
                
                <div id="formResponse" class="form-response" role="alert" aria-live="polite"></div>
            </form>
        </div>
        </div>
    </div>
    <iframe 
    id="backend-bridge" 
    src="https://thmscmpg.github.io/backend-hub/" 
    style="display:none; width:0; height:0; border:0;">
</iframe>
</section>

<style>
/* Contact Form Styles */
.contact-card {
    max-width: 600px;
    margin: 0 auto;
    padding: 30px;
}

.section-description {
    text-align: center;
    margin-bottom: 30px;
    color: #666;
    font-size: 1.1rem;
}

.contact-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-weight: 600;
    color: #333;
    font-size: 0.95rem;
}

.form-input {
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    transition: all 0.3s ease;
    background: #fff;
}

.form-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-input.error {
    border-color: #f44336;
}

.form-input.success {
    border-color: #4CAF50;
}

.form-textarea {
    resize: vertical;
    min-height: 120px;
}

.form-error {
    color: #f44336;
    font-size: 0.85rem;
    min-height: 20px;
    display: none;
}

.form-error.visible {
    display: block;
}

.character-count {
    text-align: right;
    font-size: 0.85rem;
    color: #999;
}

.submit-btn {
    padding: 14px 32px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
}

.submit-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.submit-btn:active:not(:disabled) {
    transform: translateY(0);
}

.submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-icon {
    font-size: 1.2rem;
}

.form-response {
    padding: 15px;
    border-radius: 8px;
    font-weight: 500;
    text-align: center;
    display: none;
    animation: slideIn 0.3s ease;
}

.form-response.visible {
    display: block;
}

.success-msg {
    background: #e8f5e9;
    color: #2e7d32;
    border: 2px solid #4CAF50;
}

.error-msg {
    background: #ffebee;
    color: #c62828;
    border: 2px solid #f44336;
}

.contact-alternatives {
    text-align: center;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.alt-contact-text {
    color: #666;
    font-size: 0.95rem;
}

.contact-link {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
    transition: color 0.3s ease;
}

.contact-link:hover {
    color: #764ba2;
    text-decoration: underline;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .contact-card {
        padding: 20px;
    }
    
    .submit-btn {
        width: 100%;
    }
}
</style>

<script>
(function() {
    'use strict';
    
    // Configuration
    const CONFIG = {
        // We no longer need the API_URL here, the Bridge handles it.
        MAX_MESSAGE_LENGTH: 5000,
        MIN_MESSAGE_LENGTH: 10,
        TIMEOUT: 10000 
    };
    
    // --- BRIDGE COMMUNICATION FUNCTION ---
    function sendToBridge(payload) {
        return new Promise((resolve, reject) => {
            const iframe = document.getElementById('backend-bridge');
            if (!iframe) {
                reject(new Error("Bridge iframe not found"));
                return;
            }

            const requestId = Date.now(); // Unique ID for this specific request

            // Define listener for the response
            const handleResponse = (event) => {
                // Security check
                if (event.origin !== window.location.origin) return;
                // Only handle the message meant for this specific request ID
                if (!event.data.id || event.data.id !== requestId) return;

                // Cleanup: Remove listener so it doesn't pile up
                window.removeEventListener('message', handleResponse);

                if (event.data.status === 'success') {
                    resolve(event.data.data);
                } else {
                    reject(new Error(event.data.error));
                }
            };

            // Start listening
            window.addEventListener('message', handleResponse);

            // Send message to Iframe
            iframe.contentWindow.postMessage({ 
                action: 'SUBMIT_CONTACT', 
                id: requestId,
                payload: payload 
            }, '*');
            
            // Safety timeout in case the bridge never replies
            setTimeout(() => {
                window.removeEventListener('message', handleResponse);
                reject(new Error("Request timed out - Bridge did not respond"));
            }, CONFIG.TIMEOUT);
        });
    }

    // --- FORM LOGIC (Unchanged mostly, except the submit handler) ---
    
    const form = document.getElementById('contactForm');
    const nameInput = document.getElementById('contactName');
    const emailInput = document.getElementById('contactEmail');
    const messageInput = document.getElementById('contactMessage');
    const submitBtn = document.getElementById('submitBtn');
    const responseDiv = document.getElementById('formResponse');
    const charCount = document.getElementById('charCount');
    
    // ... [Validation Helpers match your original code] ...
    const validators = {
        name: (value) => (!value || value.trim().length < 2) ? 'Name must be at least 2 characters' : (value.length > 100 ? 'Name is too long' : null),
        email: (value) => (!value || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) ? 'Invalid email' : (value.length > 150 ? 'Email is too long' : null),
        message: (value) => (!value || value.trim().length < CONFIG.MIN_MESSAGE_LENGTH) ? `Message too short` : (value.length > CONFIG.MAX_MESSAGE_LENGTH ? `Message too long` : null)
    };

    function showError(inputId, message) {
        const input = document.getElementById(inputId);
        const errorSpan = document.getElementById(`${inputId.replace('contact', '').toLowerCase()}Error`);
        if (input && errorSpan) {
            input.classList.add('error');
            input.classList.remove('success');
            errorSpan.textContent = message;
            errorSpan.classList.add('visible');
        }
    }

    function clearError(inputId) {
        const input = document.getElementById(inputId);
        const errorSpan = document.getElementById(`${inputId.replace('contact', '').toLowerCase()}Error`);
        if (input && errorSpan) {
            input.classList.remove('error');
            input.classList.add('success');
            errorSpan.textContent = '';
            errorSpan.classList.remove('visible');
        }
    }

    function validateField(fieldName, value) {
        const error = validators[fieldName](value);
        const inputId = `contact${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)}`;
        if (error) { showError(inputId, error); return false; }
        else { clearError(inputId); return true; }
    }

    // Event Listeners for validation
    if (nameInput) nameInput.addEventListener('blur', () => validateField('name', nameInput.value));
    if (emailInput) emailInput.addEventListener('blur', () => validateField('email', emailInput.value));
    if (messageInput) {
        messageInput.addEventListener('blur', () => validateField('message', messageInput.value));
        messageInput.addEventListener('input', () => {
            if (charCount) charCount.textContent = `${messageInput.value.length} / ${CONFIG.MAX_MESSAGE_LENGTH}`;
        });
    }

    function showResponse(message, isSuccess) {
        if (!responseDiv) return;
        responseDiv.textContent = message;
        responseDiv.className = `form-response visible ${isSuccess ? 'success-msg' : 'error-msg'}`;
        if (isSuccess) setTimeout(() => responseDiv.classList.remove('visible'), 5000);
    }

    // --- NEW SUBMIT HANDLER ---
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (responseDiv) responseDiv.classList.remove('visible');
            
            // Validate all
            const v1 = validateField('name', nameInput.value);
            const v2 = validateField('email', emailInput.value);
            const v3 = validateField('message', messageInput.value);
            if (!v1 || !v2 || !v3) { showResponse('Please fix errors', false); return; }
            
            // UI Loading State
            submitBtn.disabled = true;
            const btnText = submitBtn.querySelector('.btn-text');
            const originalText = btnText.textContent;
            btnText.textContent = 'Sending...';
            
            // Prepare Data
            const formData = {
                name: nameInput.value.trim(),
                email: emailInput.value.trim(),
                message: messageInput.value.trim(),
                website_hp: document.getElementById('website_hp')?.value || ''
            };
            
            try {
                // !!! HERE IS THE CHANGE: Use Bridge instead of Fetch !!!
                const data = await sendToBridge(formData);
                
                // Success Handling
                showResponse(data.message || 'Message sent successfully!', true);
                form.reset();
                [nameInput, emailInput, messageInput].forEach(i => i.classList.remove('success'));
                if (charCount) charCount.textContent = '0 / 5000';

            } catch (error) {
                console.error('Bridge Error:', error);
                showResponse(error.message || 'Failed to send message via bridge.', false);
            } finally {
                submitBtn.disabled = false;
                btnText.textContent = originalText;
            }
        });
    }
    
    console.log('âœ“ Contact form initialized with Bridge');
})();
</script>
